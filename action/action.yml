name: 'ALPHA - Autonomous IAM Hardening'
description: 'Analyze IAM roles with AWS Access Analyzer and Bedrock, generate least-privilege policies, and create automated rollout plans'
author: 'ALPHA Team'

branding:
  icon: 'shield'
  color: 'blue'

inputs:
  mode:
    description: 'Operation mode: analyze, propose, or apply'
    required: true
  role_arn:
    description: 'IAM role ARN to analyze (required for analyze mode)'
    required: false
  usage_days:
    description: 'Days of CloudTrail history to analyze (default: 30)'
    required: false
    default: '30'
  guardrails:
    description: 'Guardrail preset: none, sandbox, or prod (default: prod)'
    required: false
    default: 'prod'
  exclude_services:
    description: 'Comma-separated list of AWS services to exclude (e.g., ec2,iam)'
    required: false
  suppress_actions:
    description: 'Comma-separated list of actions to suppress (e.g., s3:DeleteBucket)'
    required: false
  baseline_policy_name:
    description: 'Existing inline policy name to diff against'
    required: false
  output_path:
    description: 'Path to save proposal JSON (default: alpha-proposal.json)'
    required: false
    default: 'alpha-proposal.json'
  mock_mode:
    description: 'Use deterministic mock data for testing (true/false)'
    required: false
    default: 'false'

  # Propose mode inputs
  repo:
    description: 'GitHub repository (e.g., owner/repo) for propose mode'
    required: false
  branch:
    description: 'Branch name for PR (required for propose mode)'
    required: false
  base_branch:
    description: 'Base branch for PR (default: main)'
    required: false
    default: 'main'
  pr_title:
    description: 'Custom PR title (auto-generated if not provided)'
    required: false
  draft_pr:
    description: 'Create as draft PR (true/false)'
    required: false
    default: 'false'

  # Apply mode inputs
  state_machine_arn:
    description: 'Step Functions state machine ARN (required for apply mode)'
    required: false
  environment:
    description: 'Target environment: sandbox, canary, or prod (default: prod)'
    required: false
    default: 'prod'
  canary_percent:
    description: 'Canary rollout percentage (default: 10)'
    required: false
    default: '10'
  rollback_threshold:
    description: 'Rollback threshold expression (default: AccessDenied>0.1%)'
    required: false
    default: 'AccessDenied>0.1%'
  require_approval:
    description: 'Require human approval before rollout (true/false)'
    required: false
    default: 'true'
  approval_table:
    description: 'DynamoDB table name for approvals'
    required: false
  dry_run:
    description: 'Show what would be done without executing (true/false)'
    required: false
    default: 'false'

outputs:
  exit_code:
    description: 'Exit code: 0=success, 1=error, 2=risky, 3=guardrail-violation'
    value: ${{ steps.alpha.outputs.exit_code }}
  proposal_path:
    description: 'Path to generated proposal JSON'
    value: ${{ steps.alpha.outputs.proposal_path }}
  pr_url:
    description: 'GitHub PR URL (propose mode only)'
    value: ${{ steps.alpha.outputs.pr_url }}
  execution_arn:
    description: 'Step Functions execution ARN (apply mode only)'
    value: ${{ steps.alpha.outputs.execution_arn }}

runs:
  using: 'composite'
  steps:
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Poetry
      shell: bash
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install ALPHA
      shell: bash
      run: |
        # If running from the action directory, install local package
        if [ -f "${{ github.action_path }}/../pyproject.toml" ]; then
          cd "${{ github.action_path }}/.."
          poetry install
        else
          # Otherwise install from PyPI (future release)
          pip install alpha-agent
        fi

    - name: Run ALPHA
      id: alpha
      shell: bash
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        set +e  # Don't fail on non-zero exit codes

        # Build command based on mode
        if [ "${{ inputs.mode }}" == "analyze" ]; then
          CMD="alpha analyze --role-arn ${{ inputs.role_arn }}"
          CMD="$CMD --usage-days ${{ inputs.usage_days }}"
          CMD="$CMD --guardrails ${{ inputs.guardrails }}"
          CMD="$CMD --output ${{ inputs.output_path }}"

          [ -n "${{ inputs.exclude_services }}" ] && CMD="$CMD --exclude-services ${{ inputs.exclude_services }}"
          [ -n "${{ inputs.suppress_actions }}" ] && CMD="$CMD --suppress-actions ${{ inputs.suppress_actions }}"
          [ -n "${{ inputs.baseline_policy_name }}" ] && CMD="$CMD --baseline-policy-name ${{ inputs.baseline_policy_name }}"
          [ "${{ inputs.mock_mode }}" == "true" ] && CMD="$CMD --mock-mode"

        elif [ "${{ inputs.mode }}" == "propose" ]; then
          CMD="alpha propose --repo ${{ inputs.repo }}"
          CMD="$CMD --branch ${{ inputs.branch }}"
          CMD="$CMD --input ${{ inputs.output_path }}"
          CMD="$CMD --base ${{ inputs.base_branch }}"

          [ -n "${{ inputs.pr_title }}" ] && CMD="$CMD --title '${{ inputs.pr_title }}'"
          [ "${{ inputs.draft_pr }}" == "true" ] && CMD="$CMD --draft"

        elif [ "${{ inputs.mode }}" == "apply" ]; then
          CMD="alpha apply --state-machine-arn ${{ inputs.state_machine_arn }}"
          CMD="$CMD --proposal ${{ inputs.output_path }}"
          CMD="$CMD --environment ${{ inputs.environment }}"
          CMD="$CMD --canary ${{ inputs.canary_percent }}"
          CMD="$CMD --rollback-threshold '${{ inputs.rollback_threshold }}'"

          [ "${{ inputs.require_approval }}" == "true" ] && CMD="$CMD --require-approval"
          [ -n "${{ inputs.approval_table }}" ] && CMD="$CMD --approval-table ${{ inputs.approval_table }}"
          [ "${{ inputs.dry_run }}" == "true" ] && CMD="$CMD --dry-run"
          [ "${{ inputs.mock_mode }}" == "true" ] && CMD="$CMD --mock-mode"
        else
          echo "âŒ Invalid mode: ${{ inputs.mode }}"
          exit 1
        fi

        # Execute command and capture output
        echo "ðŸš€ Running: $CMD"
        eval $CMD
        EXIT_CODE=$?

        # Set outputs
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        echo "proposal_path=${{ inputs.output_path }}" >> $GITHUB_OUTPUT

        exit $EXIT_CODE

    - name: Upload proposal artifact
      if: inputs.mode == 'analyze' && always()
      uses: actions/upload-artifact@v4
      with:
        name: alpha-proposal
        path: ${{ inputs.output_path }}
        retention-days: 30
