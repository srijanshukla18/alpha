name: ALPHA - Apply IAM Hardening on Merge

on:
  push:
    branches:
      - main
    paths:
      - 'alpha-proposals/**/*.json'

permissions:
  id-token: write  # Required for AWS OIDC
  contents: read

jobs:
  apply-hardening:
    name: Apply IAM Policy Hardening
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find approved proposals
        id: find-proposals
        run: |
          # Find all proposal JSON files in the alpha-proposals directory
          PROPOSALS=$(find alpha-proposals -name "*.json" -type f)

          if [ -z "$PROPOSALS" ]; then
            echo "No proposals found"
            exit 0
          fi

          echo "Found proposals:"
          echo "$PROPOSALS"

          # Export for next step (convert to JSON array)
          echo "proposals<<EOF" >> $GITHUB_OUTPUT
          echo "$PROPOSALS" | jq -R -s -c 'split("\n")[:-1]' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        if: steps.find-proposals.outputs.proposals != '[]'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/GitHubActionsAlphaApplier
          aws-region: us-east-1

      - name: Apply proposals
        if: steps.find-proposals.outputs.proposals != '[]'
        env:
          STATE_MACHINE_ARN: arn:aws:states:us-east-1:123456789012:stateMachine/AlphaRollout
          APPROVAL_TABLE: AlphaApprovals
        run: |
          # Parse proposals array
          echo '${{ steps.find-proposals.outputs.proposals }}' | jq -r '.[]' | while read -r proposal; do
            echo "ðŸ“ Applying proposal: $proposal"

            # Use the ALPHA action to apply each proposal
            alpha apply \
              --state-machine-arn $STATE_MACHINE_ARN \
              --proposal "$proposal" \
              --environment prod \
              --canary 10 \
              --rollback-threshold "AccessDenied>0.1%" \
              --require-approval \
              --approval-table $APPROVAL_TABLE

            EXIT_CODE=$?

            if [ $EXIT_CODE -ne 0 ]; then
              echo "âŒ Failed to apply $proposal (exit code: $EXIT_CODE)"
              exit $EXIT_CODE
            fi

            echo "âœ… Successfully started rollout for $proposal"
          done

      - name: Monitor rollout
        if: steps.find-proposals.outputs.proposals != '[]'
        run: |
          echo "ðŸ” Rollout started. Monitor progress at:"
          echo "https://console.aws.amazon.com/states/home?region=us-east-1#/statemachines"
          echo ""
          echo "Rollout will automatically:"
          echo "  1. Deploy to canary (10% of traffic)"
          echo "  2. Monitor for AccessDenied errors"
          echo "  3. Auto-rollback if threshold exceeded"
          echo "  4. Promote to 100% if successful"

  cleanup-proposals:
    name: Archive Applied Proposals
    runs-on: ubuntu-latest
    needs: apply-hardening
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Archive proposals
        run: |
          # Move applied proposals to archive
          mkdir -p alpha-proposals/archive/$(date +%Y-%m-%d)
          mv alpha-proposals/*.json alpha-proposals/archive/$(date +%Y-%m-%d)/ 2>/dev/null || true

      - name: Commit archive
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add alpha-proposals/archive
          git commit -m "Archive applied ALPHA proposals [skip ci]" || true
          git push
