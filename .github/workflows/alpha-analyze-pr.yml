name: ALPHA - Analyze IAM Roles on PR

on:
  pull_request:
    paths:
      - 'terraform/iam_roles/**'
      - 'cloudformation/iam/**'
      - '.github/workflows/alpha-*.yml'

permissions:
  id-token: write  # Required for AWS OIDC
  contents: read
  pull-requests: write  # For posting comments

jobs:
  analyze-roles:
    name: Analyze IAM Role Changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        role:
          - arn:aws:iam::123456789012:role/DataPipelineProcessor
          - arn:aws:iam::123456789012:role/GitHubActionsCIRunner
          - arn:aws:iam::123456789012:role/LambdaExecutionRole
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789012:role/GitHubActionsAlphaAnalyzer
          aws-region: us-east-1

      - name: Run ALPHA analysis
        id: analyze
        uses: ./action  # Use local action (or your-org/alpha@v1 when published)
        with:
          mode: analyze
          role_arn: ${{ matrix.role }}
          usage_days: 30
          guardrails: prod
          exclude_services: 'organizations,account'
          output_path: alpha-proposal-${{ matrix.role }}.json

      - name: Check risk level
        if: steps.analyze.outputs.exit_code == '2'
        run: |
          echo "⚠️ High risk detected for ${{ matrix.role }}"
          echo "Review the proposal carefully before proceeding"

      - name: Block on guardrail violations
        if: steps.analyze.outputs.exit_code == '3'
        run: |
          echo "❌ Guardrail violations detected for ${{ matrix.role }}"
          echo "Policy contains blocked actions or missing required conditions"
          exit 1

      - name: Post PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const proposalPath = '${{ steps.analyze.outputs.proposal_path }}';

            if (!fs.existsSync(proposalPath)) {
              console.log('No proposal file found');
              return;
            }

            const proposal = JSON.parse(fs.readFileSync(proposalPath, 'utf8'));
            const exitCode = ${{ steps.analyze.outputs.exit_code }};

            const statusEmoji = exitCode === 0 ? '✅' : exitCode === 2 ? '⚠️' : '❌';
            const statusText = exitCode === 0 ? 'Safe' : exitCode === 2 ? 'Risky' : 'Violations';

            const comment = `
            ## ${statusEmoji} ALPHA Analysis: \`${{ matrix.role }}\`

            **Status**: ${statusText} (exit code: ${exitCode})
            **Risk**: ${(proposal.proposal.riskSignal.probabilityOfBreak * 100).toFixed(1)}%

            ### Policy Changes
            - **Removed Actions**: ${proposal.diff?.removedActions?.length || 0}
            - **Added Actions**: ${proposal.diff?.addedActions?.length || 0}
            - **Guardrail Violations**: ${proposal.proposal.guardrailViolations.length}

            ### Recommendation
            ${proposal.proposal.rationale}

            <details>
            <summary>View full proposal</summary>

            \`\`\`json
            ${JSON.stringify(proposal.proposal.proposedPolicy, null, 2)}
            \`\`\`

            </details>

            ---
            *Generated by ALPHA - [View artifact](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  summary:
    name: Analysis Summary
    runs-on: ubuntu-latest
    needs: analyze-roles
    if: always()
    steps:
      - name: Check results
        run: |
          echo "✅ ALPHA analysis complete for all roles"
          echo "Review PR comments for detailed recommendations"
